<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" >
        <title>Deployment Component Visualization</title>
        <script type="text/javascript" src="static/js/d3.v7.js"></script>
        <style>
            * {
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f5f5f5;
            }

            h1 {
                color: #333;
                margin-bottom: 30px;
            }

            h3 {
                color: #555;
                margin: 30px 0 10px 0;
            }

            #graphs {
                max-width: 1200px;
            }

            .graph-container {
                background: white;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 30px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            svg {
                display: block;
            }

            path {
                fill: none;
                stroke: #aaa;
            }

            path.cpu-values {
                stroke: #2563eb;
                stroke-width: 3;
            }

            path.cpu-totals {
                stroke: #dc2626;
                stroke-width: 2;
                stroke-dasharray: 5, 5;
            }

            .axis text {
                font-size: 12px;
                fill: #666;
            }

            .axis line,
            .axis path {
                stroke: #ddd;
            }

            .axis-label {
                font-size: 13px;
                font-weight: 500;
                fill: #333;
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }

            .error {
                background: #fee;
                border: 1px solid #fcc;
                border-radius: 4px;
                padding: 15px;
                color: #c33;
                margin: 20px 0;
            }
        </style>
    </head>

    <body>
        <h1>Deployment Component Visualization</h1>
        <div id="graphs">
            <div class="loading">Loading data...</div>
        </div>
        <script type='text/javascript'>
            'use strict';

            class DeploymentVisualizer {
                constructor(containerId) {
                    this.container = document.getElementById(containerId);
                    this.config = {
                        size: { x: 900, y: 350 },
                        margin: { top: 20, right: 20, bottom: 30, left: 50 }
                    };
                    this.config.graphSize = {
                        x: this.config.size.x - this.config.margin.left - this.config.margin.right,
                        y: this.config.size.y - this.config.margin.top - this.config.margin.bottom
                    };
                }

                async fetchData() {
                    try {
                        const response = await fetch('/dcs');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        this.showError(`Failed to load data: ${error.message}`);
                        throw error;
                    }
                }

                showError(message) {
                    this.container.innerHTML = `<div class="error">${message}</div>`;
                }

                render(cpuData) {
                    this.container.innerHTML = '';
                    
                    cpuData.forEach((dcData, index) => {
                        this.createGraph(dcData, index);
                    });
                }

                createGraph(dcData, index) {
                    const maxIndex = dcData.values[0].length - 1;
                    const clipId = `clip${index}`;

                    // Create container
                    const graphContainer = document.createElement('div');
                    graphContainer.className = 'graph-container';
                    
                    const title = document.createElement('h3');
                    title.textContent = dcData.name;
                    graphContainer.appendChild(title);

                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('width', this.config.size.x);
                    svg.setAttribute('height', this.config.size.y);
                    graphContainer.appendChild(svg);

                    this.container.appendChild(graphContainer);

                    // Use D3 for the actual charting
                    this.renderD3Graph(svg, dcData, maxIndex, clipId);
                }

                renderD3Graph(svgElement, dcData, maxIndex, clipId) {
                    const { margin, graphSize } = this.config;
                    const svg = d3.select(svgElement);

                    // Create clip path
                    svg.append('defs')
                        .append('clipPath')
                        .attr('id', clipId)
                        .append('rect')
                        .attr('width', graphSize.x)
                        .attr('height', graphSize.y);

                    // Create main graph group
                    const graph = svg.append('g')
                          .attr('transform', `translate(${margin.left}, ${margin.top})`);

                    // Create scales
                    const x = d3.scaleLinear()
                          .domain(d3.extent(dcData.values, d => d[0]))
                          .range([0, graphSize.x]);

                    const y = d3.scaleLinear()
                          .domain([0, d3.max(dcData.values, d => d[maxIndex])])
                          .range([graphSize.y, 0]);

                    // Create axes
                    const xAxis = d3.axisBottom(x);
                    const yAxis = d3.axisLeft(y);

                    // X axis
                    graph.append('g')
                        .attr('transform', `translate(0, ${graphSize.y})`)
                        .attr('class', 'axis axis-x')
                        .call(xAxis)
                        .append('text')
                        .attr('class', 'axis-label')
                        .attr('x', graphSize.x)
                        .attr('y', 25)
                        .attr('text-anchor', 'end')
                        .text('Time');

                    // Y axis
                    graph.append('g')
                        .attr('class', 'axis')
                        .call(yAxis)
                        .append('text')
                        .attr('class', 'axis-label')
                        .attr('transform', 'rotate(-90)')
                        .attr('y', -40)
                        .attr('x', 0)
                        .attr('text-anchor', 'end')
                        .text('CPU');

                    // Create clipped area for lines
                    const mainArea = graph.append('g')
                          .attr('clip-path', `url(#${clipId})`);

                    // Line generator for values
                    const valueLineGenerator = d3.line()
                          .curve(d3.curveStepAfter)
                          .x(d => Math.trunc(x(d[0])))
                          .y(d => Math.trunc(y(d[1])));

                    // Draw values line
                    mainArea.append('path')
                        .datum(dcData.values)
                        .attr('class', 'cpu-values zoomable')
                        .attr('d', valueLineGenerator);

                    // Draw totals line if present
                    if (maxIndex > 1) {
                        const totalLineGenerator = d3.line()
                              .curve(d3.curveStepAfter)
                              .x(d => Math.trunc(x(d[0])))
                              .y(d => Math.trunc(y(d[2])))
                              .defined(d => d.length > 2);

                        mainArea.append('path')
                            .datum(dcData.values)
                            .attr('class', 'cpu-totals zoomable')
                            .attr('d', totalLineGenerator);
                    }

                    // Add zoom behavior
                    const zoom = d3.zoom()
                          .scaleExtent([1, Infinity])
                          .translateExtent([[margin.left, margin.top], [graphSize.x, graphSize.y]])
                          .on('zoom', (event) => {
                              const t = event.transform;
                              
                              graph.selectAll('.zoomable')
                                  .attr('transform', `translate(${t.x}, 0) scale(${t.k}, 1)`);
                              
                              graph.select('.axis-x')
                                  .call(xAxis.scale(t.rescaleX(x)));
                          });

                    svg.call(zoom);
                }
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', async () => {
                const visualizer = new DeploymentVisualizer('graphs');
                
                try {
                    const cpuData = await visualizer.fetchData();
                    visualizer.render(cpuData);
                } catch (error) {
                    console.error('Visualization failed:', error);
                }
            });

        </script>
    </body>
</html>

